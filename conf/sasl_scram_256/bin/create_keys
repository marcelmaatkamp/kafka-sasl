#!/bin/bash
# https://github.com/Mongey/terraform-provider-kafka/blob/master/secrets/create-certs.sh

set -o nounset \
  -o errexit \
  -o verbose \
  -o xtrace

PASS=confluent
WORKDIR=conf/kafka/keys
CA=ca

# Generate CA key
openssl req \
  -new \
  -x509 \
  -keyout ${WORKDIR}/${CA}.key \
  -out ${WORKDIR}/${CA}.crt \
  -days 365 \
  -subj '/CN=ca1.test.confluent.io/OU=TEST/O=CONFLUENT/L=PaloAlto/S=Ca/C=US' \
  -passin pass:$PASS \
  -passout pass:$PASS

# Kafkacat
# Private KEY
openssl genrsa \
  -des3 \
  -passout "pass:$PASS" \
  -out ${WORKDIR}/kafkacat.client.key \
  1024

# Signing Request
openssl req \
  -passin "pass:$PASS" \
  -passout "pass:$PASS" \
  -key ${WORKDIR}/kafkacat.client.key \
  -new \
  -out ${WORKDIR}/kafkacat.client.req \
  -subj '/CN=kafkacat.test.confluent.io/OU=TEST/O=CONFLUENT/L=PaloAlto/S=Ca/C=US'

# Signed Key
openssl x509 -req \
  -CA ${WORKDIR}/${CA}.crt \
  -CAkey ${WORKDIR}/${CA}.key \
  -in ${WORKDIR}/kafkacat.client.req \
  -out ${WORKDIR}/kafkacat-ca1-signed.pem \
  -days 9999 \
  -CAcreateserial \
  -passin "pass:$PASS"

## generate for golang

echo "generating a private key without passphrase"
openssl rsa \
  -in ${WORKDIR}/kafkacat.client.key \
  -passin "pass:$PASS" \
  -out ${WORKDIR}/kafkacat-raw-private-key.pem

for i in kafka
do
  echo $i
  # Create keystores
  keytool -genkey -noprompt \
    -alias $i \
    -dname "CN=localhost, OU=TEST, O=CONFLUENT, L=PaloAlto, S=Ca, C=US" \
    -keystore ${WORKDIR}/${i}.jks \
    -keyalg RSA \
    -ext SAN=dns:${BROKER} \
    -storepass $PASS \
    -keypass $PASS

  # Create CSR, sign the key and import back into keystore
  keytool  \
    -keystore ${WORKDIR}/${i}.jks \
    -alias $i \
    -certreq \
    -file ${WORKDIR}/${i}.csr \
    -storepass $PASS \
    -keypass $PASS

  openssl x509 \
    -req \
    -CA ${WORKDIR}/${CA}.crt  \
    -CAkey ${WORKDIR}/${CA}.key \
    -in ${WORKDIR}/${i}.csr \
    -out ${WORKDIR}/${i}.crt \
    -days 9999 \
    -CAcreateserial \
    -passin pass:$PASS

  keytool \
    -keystore ${WORKDIR}/${i}.jks \
    -alias CARoot \
    -import \
    -file ${WORKDIR}/${CA}.crt \
    -storepass $PASS \
    -keypass $PASS

  keytool -keystore ${WORKDIR}/${i}.jks \
    -alias $i \
    -import \
    -file ${WORKDIR}/${i}.crt \
    -storepass $PASS \
    -keypass $PASS

  # Create truststore and import the CA cert.
  keytool -keystore ${WORKDIR}/${i}.jks \
    -alias CARoot \
    -import \
    -file ${WORKDIR}/${CA}.crt \
    -storepass $PASS \
    -keypass $PASS

  echo $PASS > ${WORKDIR}/${i}_sslkey_creds
  echo $PASS > ${WORKDIR}/${i}_keystore_creds
  echo $PASS > ${WORKDIR}/${i}_truststore_creds
done

